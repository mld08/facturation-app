{% extends "base.html" %}

{% block content %}
<div class="bg-white rounded-lg shadow-lg p-6">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">
            <i class="fas fa-edit mr-2 text-orange-600"></i>Modifier la Facture {{ facture.numero_facture }}
        </h2>
        <div class="flex space-x-2">
            <a href="{{ url_for('voir_facture', id=facture.id) }}" 
               class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-eye mr-2"></i>Voir
            </a>
            <a href="{{ url_for('liste_factures') }}" 
               class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Retour
            </a>
        </div>
    </div>

    <form method="POST" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Date de Facture</label>
                <input type="date" name="date_facture" required
                       value="{{ facture.date_facture.strftime('%Y-%m-%d') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Société</label>
                <select name="societe_id" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Sélectionner une société</option>
                    {% for societe in societes %}
                        <option value="{{ societe.id }}" {% if societe.id == facture.societe_id %}selected{% endif %}>
                            {{ societe.nom_societe }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Sélection du certificat -->
        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-certificate mr-2 text-yellow-600"></i>Certificat (Optionnel)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sélectionner un certificat</label>
                    <select name="certificat_id" id="certificat_select" onchange="remplirDepuisCertificat()"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <option value="">Aucun certificat (saisie manuelle)</option>
                        {% for certificat in certificats %}
                            <option value="{{ certificat.id_certificat }}" 
                                    {% if certificat.id_certificat == facture.certificat_id %}selected{% endif %}
                                    data-numero="{{ certificat.numero_certificat }}"
                                    data-nombre="{{ certificat.nombre_certificats }}"
                                    data-poids="{{ certificat.poids_certifie_kg or '' }}">
                                Certificat N° {{ certificat.numero_certificat }} 
                                ({{ certificat.nombre_certificats }} certificats
                                {% if certificat.poids_certifie_kg %}, {{ certificat.poids_certifie_kg }} kg{% endif %})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="button" onclick="viderChampsCertificat()" 
                            class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors">
                        <i class="fas fa-eraser mr-2"></i>Saisie manuelle
                    </button>
                </div>
            </div>
            {% if facture.certificat %}
            <div class="mt-3 p-3 bg-yellow-100 rounded-lg">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Certificat actuellement lié :</strong> N° {{ facture.certificat.numero_certificat }}
                    ({{ facture.certificat.nombre_certificats }} certificats
                    {% if facture.certificat.poids_certifie_kg %}, {{ facture.certificat.poids_certifie_kg }} kg{% endif %})
                </p>
            </div>
            {% endif %}
        </div>

        <!-- Mode de calcul -->
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Mode de Calcul</h3>
            <div class="flex space-x-6">
                <label class="flex items-center">
                    <input type="radio" name="mode_calcul" value="poids" 
                           {% if facture.mode_calcul == 'poids' %}checked{% endif %} 
                           onchange="toggleModeCalcul()"
                           class="mr-2 text-blue-600 focus:ring-blue-500">
                    <span class="text-sm font-medium text-gray-700">Calcul par poids (Prix unitaire × Poids)</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="mode_calcul" value="certificat" 
                           {% if facture.mode_calcul == 'certificat' %}checked{% endif %} 
                           onchange="toggleModeCalcul()"
                           class="mr-2 text-blue-600 focus:ring-blue-500">
                    <span class="text-sm font-medium text-gray-700">Calcul par certificat (Nombre certificats × Prix par certificat)</span>
                </label>
            </div>
        </div>

        <!-- Détails de la facture -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Détail de la Facture</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="champ_prix_unitaire">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prix unitaire (FCFA)</label>
                    <input type="number" name="prix_unitaire" id="prix_unitaire" step="0.01" min="0"
                           value="{{ facture.prix_unitaire if facture.prix_unitaire else '' }}"
                           oninput="calculerMontant()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Nombre de certificats
                        <span id="certificat_auto_indicator" class="text-xs text-green-600" style="display: none;">
                            (rempli automatiquement)
                        </span>
                    </label>
                    <input type="number" name="nombre_certificats" id="nombre_certificats" required min="1" 
                           value="{{ facture.nombre_certificats }}"
                           oninput="calculerMontant()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Champ Poids -->
                <div id="champ_poids">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Poids (kg)
                        <span id="poids_auto_indicator" class="text-xs text-green-600" style="display: none;">
                            (rempli automatiquement)
                        </span>
                    </label>
                    <input type="number" name="poids" id="poids" step="0.01" min="0.01"
                           value="{{ facture.poids if facture.poids else '' }}"
                           oninput="calculerMontant()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Champ Prix par certificat -->
                <div id="champ_prix_certificat" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Prix par certificat (FCFA)
                    </label>
                    <input type="number" name="prix_par_certificat" id="prix_par_certificat" step="0.01" min="0"
                           value="{{ facture.prix_par_certificat if facture.prix_par_certificat else '' }}"
                           oninput="calculerMontant()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Entité</label>
                    <select name="entite" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Aéroport" {% if facture.entite == 'Aéroport' %}selected{% endif %}>Aéroport</option>
                        <option value="DPSP" {% if facture.entite == 'DPSP' %}selected{% endif %}>DPSP</option>
                    </select>
                </div>

                <div class="col-span-2 text-right pt-4">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <p class="text-lg font-semibold text-gray-800">
                            Mode de calcul : <span id="mode_affiche" class="text-blue-600">Par poids</span>
                        </p>
                        <p class="text-xl font-bold text-green-600">
                            Montant total : <span id="montant_total">{{ "%.2f"|format(facture.prix_total|float) }} FCFA</span>
                        </p>
                        <p id="calcul_detail" class="text-sm text-gray-600 mt-2"></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-end space-x-4 pt-6 border-t">
            <a href="{{ url_for('voir_facture', id=facture.id) }}" 
               class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                Annuler
            </a>
            <button type="submit" 
                    class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition-colors">
                <i class="fas fa-save mr-2"></i>Enregistrer les modifications
            </button>
        </div>
    </form>
</div>

<!-- JS pour calcul dynamique et gestion des certificats -->
<script>
    // Variables pour mémoriser l'état initial
    let certificatInitialementLie = {{ 'true' if facture.certificat_id else 'false' }};
    let valeursCertificatOriginales = {
        nombreCertificats: {{ facture.nombre_certificats }},
        poids: {{ facture.poids if facture.poids else 'null' }}
    };

    function remplirDepuisCertificat() {
        const select = document.getElementById('certificat_select');
        const selectedOption = select.options[select.selectedIndex];
        
        const nombreCertificatsField = document.getElementById('nombre_certificats');
        const poidsField = document.getElementById('poids');
        const certificatIndicator = document.getElementById('certificat_auto_indicator');
        const poidsIndicator = document.getElementById('poids_auto_indicator');
        
        if (select.value && selectedOption.dataset.nombre) {
            // Remplir automatiquement les champs
            nombreCertificatsField.value = selectedOption.dataset.nombre;
            
            if (selectedOption.dataset.poids) {
                poidsField.value = selectedOption.dataset.poids;
                poidsIndicator.style.display = 'inline';
            } else {
                poidsField.value = '';
                poidsIndicator.style.display = 'none';
            }
            
            certificatIndicator.style.display = 'inline';
            
            // Désactiver les champs pour éviter la modification
            nombreCertificatsField.style.backgroundColor = '#f3f4f6';
            nombreCertificatsField.readOnly = true;
            
            if (selectedOption.dataset.poids) {
                poidsField.style.backgroundColor = '#f3f4f6';
                poidsField.readOnly = true;
            }
        } else {
            viderChampsCertificat();
        }
        
        calculerMontant();
    }
    
    function viderChampsCertificat() {
        const certificatSelect = document.getElementById('certificat_select');
        const nombreCertificatsField = document.getElementById('nombre_certificats');
        const poidsField = document.getElementById('poids');
        const certificatIndicator = document.getElementById('certificat_auto_indicator');
        const poidsIndicator = document.getElementById('poids_auto_indicator');
        
        // Réinitialiser la sélection
        certificatSelect.value = '';
        
        // Réactiver les champs
        nombreCertificatsField.readOnly = false;
        nombreCertificatsField.style.backgroundColor = 'white';
        poidsField.readOnly = false;
        poidsField.style.backgroundColor = 'white';
        
        // Masquer les indicateurs
        certificatIndicator.style.display = 'none';
        poidsIndicator.style.display = 'none';
        
        // Restaurer les valeurs originales ou par défaut
        if (certificatInitialementLie) {
            nombreCertificatsField.value = valeursCertificatOriginales.nombreCertificats;
            poidsField.value = valeursCertificatOriginales.poids || '';
        } else {
            nombreCertificatsField.value = '1';
            poidsField.value = '';
        }
        
        calculerMontant();
    }

    function toggleModeCalcul() {
        const modeRadios = document.querySelectorAll('input[name="mode_calcul"]');
        const modePoids = document.getElementById('champ_poids');
        const modePrixUnitaire = document.getElementById('champ_prix_unitaire');
        const modeCertificat = document.getElementById('champ_prix_certificat');
        const modeAffiche = document.getElementById('mode_affiche');
        const poidsInput = document.getElementById('poids');
        const prixCertificatInput = document.getElementById('prix_par_certificat');
        const prixUnitaireInput = document.getElementById('prix_unitaire');
        
        let modeSelectionne = '';
        modeRadios.forEach(radio => {
            if (radio.checked) {
                modeSelectionne = radio.value;
            }
        });

        if (modeSelectionne === 'poids') {
            modePoids.style.display = 'block';
            modeCertificat.style.display = 'none';
            modePrixUnitaire.style.display = 'block';
            modeAffiche.textContent = 'Par poids';
            
            // Rendre le poids obligatoire et le prix par certificat optionnel
            poidsInput.required = true;
            prixCertificatInput.required = false;
            prixUnitaireInput.required = true;
        } else {
            modePrixUnitaire.style.display = 'none';
            modePoids.style.display = 'none';
            modeCertificat.style.display = 'block';
            modeAffiche.textContent = 'Par certificat';
            
            // Rendre le prix par certificat obligatoire et le poids optionnel
            poidsInput.required = false;
            prixCertificatInput.required = true;
            prixUnitaireInput.required = false;
        }
        
        calculerMontant();
    }

    function calculerMontant() {
        const modeRadios = document.querySelectorAll('input[name="mode_calcul"]');
        const prixUnitaire = parseFloat(document.getElementById('prix_unitaire').value) || 0;
        const poids = parseFloat(document.getElementById('poids').value) || 0;
        const prixParCertificat = parseFloat(document.getElementById('prix_par_certificat').value) || 0;
        const nombreCertificats = parseInt(document.getElementById('nombre_certificats').value) || 1;
        
        let modeSelectionne = '';
        modeRadios.forEach(radio => {
            if (radio.checked) {
                modeSelectionne = radio.value;
            }
        });

        let montant = 0;
        let detail = '';

        if (modeSelectionne === 'poids') {
            montant = prixUnitaire * poids;
            detail = `${prixUnitaire.toFixed(2)} FCFA × ${poids.toFixed(2)} kg = ${montant.toFixed(2)} FCFA`;
        } else {
            montant = nombreCertificats * prixParCertificat;
            detail = `${nombreCertificats} × ${prixParCertificat.toFixed(2)} FCFA = ${montant.toFixed(2)} FCFA`;
        }

        document.getElementById('montant_total').textContent = montant.toFixed(2) + " FCFA";
        document.getElementById('calcul_detail').textContent = detail;
    }

    // Initialiser l'affichage au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        toggleModeCalcul();
        
        // Si un certificat est déjà sélectionné, configurer l'interface
        const certificatSelect = document.getElementById('certificat_select');
        if (certificatSelect.value) {
            remplirDepuisCertificat();
        }
        
        // Calculer le montant initial
        calculerMontant();
    });
</script>
{% endblock %}